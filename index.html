<html>
<head>
 <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
 <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
 <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
 <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<body>

 <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Welcome to OSIChat!</h4>
        </div>
        <div class="modal-body">
          <p>Tell me your name:</p>
		  <input type="text" id="myName" value="Lurker"/>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="closeName">OK</button>
        </div>
      </div>
      
    </div>
  </div>
  
<table>
<tr>
<td>
	<div id="chatspace" style="width: 400; height: 600; overflow-y: scroll">
		
	</div>

	<div>
	<input id="chatinput" type="text" style="width: 400;"/>
	</div>
</td>
<td>
<div id="whiteboard">
</div>
<button class="btn" id="penTool">Pen</button>
<button class="btn" id="eraserTool">Eraser</button>
<button class="btn" id="textTool">Text</button>
<button class="btn" id="selectTool">Select</button>

</td>
<td>
	<table width="20">
		<tr>
			<td id="red" height="20" style="background: red; cursor: pointer"> </td>
		<tr>
		<tr>
			<td id="blue" height="20" style="background: blue; cursor: pointer"> </td>
		<tr>
		<tr>
			<td id="green" height="20" style="background: green; cursor: pointer"> </td>
		<tr>
		<tr>
			<td id="black" height="20" style="background: black; cursor: pointer"> </td>
		<tr>
		<tr>
			<td id="yellow"  height="20" style="background: yellow; cursor: pointer"> </td>
		<tr>
	</table>
</td>
</tr>
</table>



<script>
</script>

<script>
var myName;

$(window).load(function(){
	$('#myModal').modal('show');
	$('#closeName').click(function() {
		myName = $('#myName').val();
		$('#myModal').modal('hide');
	});
});

var socket = io.connect(window.location.href);

var selectedTool = "pen";
var selectedColor = "black";

$("#red").click(function(){
	selectedColor = "red";
});
$("#green").click(function(){
	selectedColor = "green";
});
$("#blue").click(function(){
	selectedColor = "blue";
});
$("#black").click(function(){
	selectedColor = "black";
});
$("#yellow").click(function(){
	selectedColor = "yellow";
});



$("#penTool").click(function(){
	selectedTool = "pen";
});

$("#eraserTool").click(function(){
	selectedTool = "eraser";
});

$("#textTool").click(function(){
	selectedTool = "text";
});

$("#selectTool").click(function(){
	selectedTool = "select";
});



$("#chatinput").keypress(function(e) {
  if ( event.which == 13 ) {
	var msg = $("#chatinput").val();
	addMessage({ from: "Me",  message: msg });
	socket.emit("chat", { from: myName, message: msg });
	$("#chatinput").val("");
  }
});

var lastMessageFrom = null;

function addMessage(data) {
	if(lastMessageFrom != data.from)
	{
		$("#chatspace").append("<div style='font-weight: bold'>" + data.from + "</div>");
	}
	
	var messageText = $("<div style='padding-left: 10px'>" + data.message + "</div>");
	$("#chatspace").append(messageText);
	$("#chatspace").scrollTop($("#chatspace").scrollTop() + messageText.position().top);
	lastMessageFrom = data.from;
}


socket.on('chat', function(data){
	addMessage(data);
})			
		

var penisdown = false; // ha ha
var lastPoint = { x: 0, y : 0 }

var svg = d3.select("#whiteboard")
            .append("svg")
            .attr("width", 900)
            .attr("height", 600)
			.on("mousemove", mouseMove)
			.on("mousedown", mouseDown)
			.on("mouseup", mouseUp)
			.on("click", mouseClick)
;

$("#whiteboard").children("svg").on("keypress", function(e) {
	console.log(e);
});


var currentLine;

socket.on('newline', function(data){
	objects[data.name] = new Line(data.x, data.y, data.color);
	objects[data.name].name = data.name;
})			
		
socket.on('addpoint', function(data){
	objects[data.name].addPoint(data.x, data.y);
})			

socket.on('move', function(data){
	objects[data.name].move(data.x, data.y);
})	

socket.on('remove', function(data){
	objects[data.name].remove();
	delete objects[data.name];
})	
			
var objects = {};
var currentObject = null;

function makeid()
{
	var text = "";
	var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

	for( var i=0; i < 24; i++ )
		text += possible.charAt(Math.floor(Math.random() * possible.length));

	return text;
}
var tmp = [0, 0]

function pointCircleCollide(point, circle, r) {
    if (r===0) return false
    var dx = circle.x - point.x
    var dy = circle.y - point.y
    return dx * dx + dy * dy <= r * r
}

function lineCircleCollide(a, b, circle, radius, nearest) {
    //check to see if start or end points lie within circle 
    if (pointCircleCollide(a, circle, radius)) {
        if (nearest) {
            nearest.x = a.x
            nearest.y = a.y
        }
        return true
    } if (pointCircleCollide(b, circle, radius)) {
        if (nearest) {
            nearest.x = b.x
            nearest.y = b.y
        }
        return true
    }
    
    var x1 = a.x,
        y1 = a.y,
        x2 = b.x,
        y2 = b.y,
        cx = circle.x,
        cy = circle.y

    //vector d
    var dx = x2 - x1
    var dy = y2 - y1
    
    //vector lc
    var lcx = cx - x1
    var lcy = cy - y1
    
    //project lc onto d, resulting in vector p
    var dLen2 = dx * dx + dy * dy //len2 of d
    var px = dx
    var py = dy
    if (dLen2 > 0) {
        var dp = (lcx * dx + lcy * dy) / dLen2
        px *= dp
        py *= dp
    }
    
    if (!nearest)
        nearest = tmp
    nearest.x = x1 + px
    nearest.y = y1 + py
    
    //len2 of p
    var pLen2 = px * px + py * py
    
    //check collision
    return pointCircleCollide(nearest, circle, radius)
            && pLen2 <= dLen2 && (px * dx + py * dy) >= 0
}

	
function Line(x, y, color) {
	var lineData = [];
	var minX = 9999, minY = 9999, maxX = 0, maxY = 0;
	
	var lineFunction = d3.svg.line()
		.x(function(d) { return d.x; })
		.y(function(d) { return d.y; })
		.interpolate("linear");
	
	var lineObject = svg.append("path")
			.attr("d", lineFunction(lineData))
            .attr("stroke", color)
            .attr("stroke-width", 2)
            .attr("fill", "none");
	
	minX = maxX = x;
	minY = maxY = y;
	
	var isSelected = false;
	var origColor = color;
	var offset = { x:0, y:0 };
	
	return {
		type: 'line',
		addPoint: function(x, y) {
			if(x < minX) minX = x;
			if(x > maxX) maxX = x;
			if(y < minY) minY = y;
			if(y > maxY) maxY = y;
			lineData.push({x: x, y: y});		
			lineObject.attr("d", lineFunction(lineData));
		},
		hitTest: function(x, y) {
			if(x >= (offset.x + minX) && x <= (offset.x + maxX) && y >= (offset.y + minY) && y <= (offset.y + maxY)) 
			{
				var _lastPoint = { x: lineData[0].x + offset.x, y: lineData[0].y + offset.y };
				
				for(var i = 1; i < lineData.length; i++) {
					var point = { x: lineData[i].x + offset.x, y: lineData[i].y + offset.y };
					
					if(lineCircleCollide(point, _lastPoint, { x: x, y: y }, 5))
					{
						return true;
					}
					_lastPoint = point;
				}
			
				return false;
			} else {
				console.log("fail!");
			}
			
		},
		isSelected: isSelected,
		select: function() {
			isSelected = true;
			lineObject.attr("stroke", "magenta");
		},
		deselect: function() {
			isSelected = false;
			lineObject.attr("stroke", origColor);
		},
		remove: function() {
			lineObject.remove();
		},		
		move: function(x, y) {
			offset.x += x;
			offset.y += y;
			lineObject.attr("transform", "translate(" + offset.x + " " + offset.y + ")");
		}
	}
}
		
			
			
function mouseMove() {
	var m = d3.mouse(this);		
	if(penisdown)
	{
		if(selectedTool == "pen")
		{
			if(currentObject && currentObject.type == 'line')
			{
				currentObject.addPoint(m[0], m[1]);
			}
			socket.emit('addpoint', { name: currentObject.name, x: m[0], y: m[1] });			//socket.emit('line', { x1: lastPoint.x, y1:lastPoint.y, x2: m[0], y2: m[1] });
		}
	   else if(selectedTool == "eraser")
		{
			for(var obj in objects) {
				if(objects[obj].hitTest(m[0], m[1]))
				{
					objects[obj].remove();
					socket.emit('remove', { name: objects[obj].name });	
					delete objects[obj];
				}
			}
	   }
		else if(selectedTool == "select")
		{	
			if(currentObject)
			{
				var dx = m[0] - lastPoint.x;
				var dy = m[1] - lastPoint.y;
				currentObject.move(dx, dy);
				socket.emit('move', { name: currentObject.name, x: dx, y: dy});
			}
		}		   
		lastPoint = { x: m[0], y: m[1] }
	}
}

var selectedObject = null;
var lastPoint = null;

function mouseDown() {
    penisdown = true;
	
	var m = d3.mouse(this);		
	
	if(selectedTool == "pen")
	{
		currentObject = new Line(m[0], m[1], selectedColor);
		var name = makeid();
		currentObject.name = name;
		objects[name] = currentObject;
		socket.emit('newline', { name: name, x: m[0], y: m[1], color: selectedColor});
	}	
	else if(selectedTool == "select")
	{	
		lastPoint = { x: m[0], y: m[1] };
		currentObject = null;

		for(var obj in objects) {
			objects[obj].deselect();
		}
		
		for(var obj in objects) {
			if(objects[obj].hitTest(m[0], m[1]))
			{
				currentObject = objects[obj];
				objects[obj].select();
				break;
			}
		}
	}	
	
	
}
 
function mouseUp() {
    penisdown = false;
	if(selectedTool == "pen") {
		currentObject = null;
	}
}
 
function mouseClick() {

}			
			
</script>
</body>
</html>
